# PiCo-Gen: Physics-Informed Composite Generation for Symbolic Music

> **Efficient, Controllable, and Musically Plausible.**

## 1\. 简介 (Introduction)

**PiCo-Gen** 是一个轻量级的符号音乐生成框架。与其盲目地堆砌参数量，本项目旨在通过**知识蒸馏 (Knowledge Distillation)** 和 **物理感知损失 (Physics-Aware Loss)**，让小型学生模型（Student）在保持极低推理延迟的同时，习得大型教师模型（Teacher, 即 NotaGen）的音乐生成能力。

与市面上那些臃肿的生成模型不同，PiCo-Gen 强调：

  * **架构灵活性**：支持多种骨干网络切换（Llama, Qwen, Mamba, RWKV），打破了 Transformer 一统天下的僵局。
  * **物理规律约束**：引入基于 $1/f$ 噪声（粉红噪声）的物理感知损失，强制模型生成的音高变化符合自然界的幂律分布，避免生成“死板”或“杂乱”的序列。
  * **层级化建模**：采用 Patch-level 的处理方式，将小节（Bar）视为基础单元，既保证了局部结构的严谨，又提升了长序列生成的连贯性。

## 2\. 核心特性 (Key Features)

  * **多骨干网络支持 (Multi-Backbone Architecture)**:
      * **Transformer-based**: Llama, Qwen.
      * **RNN/SSM-based**: Mamba, RWKV.
      * 通过统一的 `GenericStudent` 接口封装，轻松对比不同架构在音乐生成任务上的表现。
  * **物理感知蒸馏 (Physics-Aware Distillation)**:
      * 结合了传统的 Logits KD (KL Divergence) 和 隐层状态对齐 (Hidden State MSE)。
      * **创新点**: `PhysicsAwareLoss` 惩罚偏离幂律分布（Power Law）的生成结果，提升音乐的自然度。
  * **鲁棒的推理管道**:
      * 包含自动的 ABC 记谱法清洗、格式修复以及 XML 转换工具。

## 3\. 环境安装 (Installation)

本项目基于 Python 3.10+。请确保安装了 PyTorch (支持 CUDA)。

```bash
# 克隆项目
git clone https://github.com/your-repo/PiCo-Gen.git
cd PiCo-Gen

# 安装依赖
pip install -r requirements.txt
```

核心依赖包括 `transformers`, `torch`, `abctoolkit`, `wandb` 等。

## 4\. 数据准备 (Data Preparation)

PiCo-Gen 使用 ABC 记谱法数据。数据需预处理为 Patch 序列。
请在 `train/config.py` 中配置数据路径：

```python
# train/config.py
DATA_TRAIN_INDEX_PATH = "data/preprocessed/SymphonyNet_dataset/symphonynet_augmented_train.jsonl"
DATA_EVAL_INDEX_PATH  = "data/preprocessed/SymphonyNet_dataset/symphonynet_augmented_eval.jsonl"
```

数据格式应为 JSONL，包含 `path` 字段指向具体的文本文件。

## 5\. 训练 (Training)

训练入口为 `main.py`。支持两种模式：`baseline` (从头训练) 和 `distill` (蒸馏训练)。

### 5.1 Baseline 训练 (Standard Training)

如果不使用 Teacher 模型，仅训练 Student 骨干网络：

```bash
python main.py \
  --mode baseline \
  --backbone llama \
  --exp_name llama_baseline_v1 \
  --batch_size 4 \
  --lr 1e-4 \
  --epochs 20
```

### 5.2 蒸馏训练 (Distillation)

加载预训练的 Teacher (NotaGen) 并蒸馏给 Student。需要指定 Teacher 的权重路径以及物理损失的权重参数。

```bash
python main.py \
  --mode distill \
  --backbone mamba \
  --exp_name mamba_distill_v1 \
  --teacher_ckpt ./checkpoints/teacher/notagen_weights.pth \
  --alpha_kd 1.0 \
  --beta_phy 0.5 \
  --batch_size 4 \
  --lr 5e-5
```

  * `--alpha_kd`: 蒸馏损失权重。
  * `--beta_phy`: 物理感知损失权重。

## 6\. 推理与生成 (Inference)

使用训练好的权重生成音乐。推理脚本位于 `inference/` 目录下。

```bash
cd inference
python generate.py \
  --weights_path ../checkpoints/llama_baseline_v1/weights_picogen_llama_best.pth \
  --backbone llama \
  --num_samples 5 \
  --max_length 1024 \
  --temperature 1.0 \
  --top_k 40 \
  --prompt "X:1\nT:My Song\nM:4/4\nK:C\n"
```

**生成后处理**：
脚本会自动执行以下操作：

1.  **结构化清洗**：分离 Metadata 和 Music Body，去除训练时的特殊标记（如 `[r:...]`）。
2.  **格式转换**：调用 `abc2xml` 将生成的 `.abc` 文件转换为 `.xml`，便于在 MuseScore 等软件中打开。

## 7\. 项目结构 (Project Structure)

```text
PiCo-Gen/
├── data/                   # 数据处理与 Tokenizer
│   ├── tokenizer.py        # Patchilizer 实现
│   └── dataset.py          # PyTorch Dataset 实现
├── models/                 # 模型定义
│   ├── backbones/          # 各种骨干网络 (Llama, Mamba, Qwen, RWKV)
│   ├── student.py          # Student 模型封装 (PiCoGen)
│   ├── teacher.py          # Teacher 模型定义 (NotaGen)
│   └── base.py             # 通用模型基类
├── train/                  # 训练逻辑
│   ├── engine.py           # 实验运行器 (ExperimentRunner)
│   ├── distiller.py        # 蒸馏 Trainer
│   ├── baseline.py         # 标准 Trainer
│   ├── losses.py           # 物理感知损失 (PhysicsAwareLoss)
│   └── config.py           # 训练配置
├── metrics/                # 评估指标
│   ├── physics.py          # 幂律分布评估
│   ├── musicality.py       # 多样性与熵评估
│   └── evaluator.py        # 评估器类
├── inference/              # 推理脚本
│   ├── generate.py         # 生成主脚本
│   └── utils.py            # 推理辅助工具
├── main.py                 # 程序主入口
└── requirements.txt        # 项目依赖
```

## 8\. License

本项目遵循 MIT License。

-----

*This README was generated by Gemini, enforcing strict logical structure upon the provided codebase.*